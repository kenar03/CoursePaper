:description: Курсовой проект
:toc:
:toc-title: Оглавление
:figure-caption: Рисунок
:table-caption: Таблица
:imagesdir: images
:important-caption: ВАЖНО!
:note-caption: ЗАМЕЧАНИЕ

= Курсовой проект

== Требования к ПО

* Для разработки должна использоваться отладочная плата https://www.waveshare.com/product/arduino-2/boards-kits/nucleo/xnucleo-f411re.htm[XNUCLEO-F411RE]
* Софт должен измерять напряжения с переменного резистора, уставленного на плате расширения
** Для измерения напряжения должен использоваться встроенный АЦП
** Период измерения должен быть 50 ms
** Для получения кода измерения должен использоваться механизм DMA
** Для изменения напряжения должна использоваться плата https://www.waveshare.com/product/arduino-2/shields/others/accessory-shield.htm[Accessories Shield] или https://www.waveshare.com/product/arduino-2/shields/others/analog-test-shield.htm[Analog Test Shield]
** Точность измерения напряжения должна быть не менее 0,01 вольта
** К измеренному напряжению должен быть применен цифровой фильтр вида: +
stem:[tau = int  ((1-e^(-dt/(R*C)), RC > 0 sec), (1, RC<= 0 sec))] +
{nbsp} +
stem:["FilteredValue" = "OldFiltered" + ("Value" - "OldValue") * tau], +
{nbsp} +
где dt -  100 мс; +
Value – текущее нефильтрованное измеренное значение напряжения; +
oldValue -  предыдущее фильтрованное значение.

* Идикация значения измеренного напряжения должна осуществляться через включение/выключение светодиодов
** При максимальном напряжении софт должен зажигать 4 светодиода, при минимальном все светодиоды должны погаснуть.
** Промежуточные значения напряжения должны индицироваться следующим образом.
*** При 0-25% от максимального напряжения зажигается только 1 светодиод
*** При 25-50% от максимального напряжения зажигается только 2 светодиода
*** При 50-75% от максимального напряжения зажигается только 3 светодиода
*** При 75-100% от максимального напряжения зажигается все 4 светодиода

* Передача значений по беспроводному интерфейсу должна осуществляться через модуль https://elecfreaks.com/estore/download/EF03073-Bluetooth_Bee_(HC-05_and_HC-06)User_Guide.pdf[BlueTooth Bee HC-06]
 или https://www.waveshare.com/product/arduino-2/shields/others/io-expansion-shield.htm[I/O Expansion Shield]
** Общение с платой расширения должно осуществляться через USART2
** формат вывод: +
   "Напряжение: " X.XXX [Units]
* Архитектура должна быть представлена в виде UML диаграмм в пакете Star UML
* Приложение должно быть написано на языке С++ с использование компилятора ARM 8.40.2
* При разработке должна использоваться Операционная Система Реального Времени FreeRTOS и https://github.com/lamer0k/RtosWrapper[С++ обертка над ней]

== Анализ требований к ПО

=== 1. Отладочная плата XNUCLEO-F411RE

Отладочная плаата XNUCLEO-F411RE - это улучшенная версия отладочной платы STM32 Nucleo, созданная компанией Waveshare. Основана XNUCLEO-F411RE на микроконтроллере STM32F411RET6 с ядром ARM Cortex-4 и предназначена для создания проектов и прототипирования. 

.Отладочная плата XNUCLEO-F411RE
image::XNUCLEO-F411RE.jpg[]

Основные особенности платы XNUCLEO-F411RE:

* совместимость с Arduino;
* подключение по USB;
* наличие светодиодов и пользовательской кнопки.

В ходе выполнения курсового проекта используется плата расширения Accessory Shield.

.Плата расширения Accessory Shield
image::accessory_shield.jpg[]

Accessory Shield - это плата расширения совместимая с популярными платформами для разработки электронных приложений, такими как Arduino UNO, Arduino Leonardo, NUCLEO, XNUCLEO и совместимыми. На плате установлены самые популярные дочерние модули, подходящие для реализации большинства задач.

Особенности платы расширения:

* разъем для подключения плат Arduino;
* разъем XBee для подключения беспроводных модулей;
* OLED дисплей 0,96 дюймов с разрешением 128x64 пикселей;
* RGB-светодиод;
* зуммер;
* потенциометр 10 кОм;
* 3-осевой цифровой акселерометр ADXL345;
* температурный датчик LM75BDP,
* джойстик 5-ти позиционный,
* индикатор состояния XBee,
* индикатор питания,
* кнопка сброса модулей XBee и Arduino,
* часы реального времени (RTC),
* держатель батареи CR1220 для RTC,
* драйвер RGB светодиода,
* джампер выбора режима Отладка/Связь.

=== 2. Софт должен измерять напряжения с переменного резистора, уставленного на плате расширения

Переменный резистор, установленный на плате расширения, согласно спецификации Waveshare, подключен к аналоговому входу микроконтроллера, пин *PA0*.

.Распиновка XNUCLEO-F411RE
image::xnucleo_spec.jpg[]

В плате расширения используется линейный потенциометр с тремя выводами:

* один крайний вывод подключен в питанию 3,3 В (стандартное напряжение питания);
* другой крайний вывод подключен к земле;
* центральный вывод выведен на аналоговый вход микроконтроллера (пин PA0).

Таким образом, при вращении ручки потенциометра напряжение на центральном выводе изменяется от 0 В до 3,3 В.

Поскольку напряжение - аналоговый сигнал, его нужно измерять с помощью аналого-цифрового преобразователя (АЦП).

=== 3. Для измерения напряжения должен использоваться встроенный АЦП с использованием DMA

Микроконтроллер STM32F411RET6 оснащен 12-битным АЦП, поддерживающим 19 каналов и позволяющим имзерять сигналы из 16 внешних источников, 2 внутренних источников, а также канал VBAT (измерение напряжения на линии питания резервной батареи).

Аналого-цифровое преобразование каналов может осуществляться в следующих режимах:

* Single Mode (однократное преобразование) - для выбранного канала преобразование выполняется один раз и останавливается после завершения.
* Continuous Mode (непрерывное преобразование) - автоматическое повторение преобразования выбранного канала без необходимости повторного запуска.
* Scan Mode (режим сканирования) - АЦП выполняет преобразование для группы каналов, заданных в последовательности, по одному за раз. Этот режим не является самостоятельным, а комбинируется с Single или Continuous.
* Discontinuous Mode (Прерывистый режим) - улучшенный режим  сканирования. Разбивает последовательность каналов на подгруппы. АЦП выполняет преобразование заданного числа каналов за один цикл, затем останавливается до следующего триггера.

Поскольку, согласно требованиям к ПО, измерять напряжение требуется с периодичностью 50 мс (т.е. по запросу), следует использовать однократное преобразование.

 Для того, чтобы настроить АЦП в режиме однократного преобразования, нужно:
 . подать тактирование на порт, который будет использоваться для считывания данных с АЦП;
 . настроить порт, подключенный к нужному каналу АЦП, на аналоговый вход;
 . подать тактирование на АЦП;
 . настроить разрешение АЦП;
 . настроить режим преобразования (регистр ADC_CR2);
 . выбрать нужный канал для измерения;
 . настроить канал АЦП на необходимую частоту преобразования;
 . включить АЦП;
 . начать преобразование;
 . дождаться флага готовности преобразования;
 . считать преобразованное значение.

В таблице ниже показаны настройки регистров, необходимых для включения АЦП в режиме одиночного преобразования.

.Настройки регистров для АЦП в режиме одиночного преобразования
|===
| Регистр | Поле (номера битов) | Значение | Назначение
| RCC_AHB1ENR | GPIOAEN (0) | 1 | Подать тактирование на порт GPIOA
| GPIOA_MODER | MODER0 (1 : 0) | 11 | Установить порт в режим аналогового входа
| RCC_APB2ENR | ADC1EN (8) | 1 | Подать тактирование на АЦП
| ADC_CR1 | RES (25 : 24) | 00 | Установить разрядность АЦП (12 бит)
.2+| ADC_CR2 | EOCS (10) | 1 | Установить тип окончания преобразования: Бит Окончания преобразования EOC устанавливается после окончания преобразования для каждого канала
| CONT (1) | 0 | Установить режим одиночного преобразования
| ADC_SQR1 | L (3 : 0) | 0000 | Установить количество преобразований равным 1
| ADC_SQR3 | SQ1 (4 : 0) | 0000 | Выбрать канал 0 для измерения
| ADD_CR2 | DMA (8) | 1 | Включить режим DMA
| ADC_SMPR2 | SMP0 (2: 0) | 100 | Установить время преобразования на 84 цикла
.2+| ADC_CR2 | ADON (0) | 1 | Запуск АЦП
| SWSTART (30) | 1 | Начать преобразование
| ADC_SR | EOC (1) | Зависит от того, окончилось ли преобразование | Проверка готовности преобразования
| ADC_DR | DATA (15 : 0) | Переменное | Используется для считывания преобразованных данных
|===

Согласно требованиям к ПО, для получения кода измерения должен использоваться механизм DMA. DMA - это режим обмена данными между периферией и основной памятью, в котором центральный процессор не участвует. Для работы с DMA в микроконтроллер встроены специальные контроллеры DMA.

На микроконтроллере STM32F411RET6 имеется 2 контроллера DMA, каждый из которых имеет 8 каналов, каждый канал имеет 8 потоков, которые подключаются к конкретному периферийному устройству. Если установлен бит DMA регистра ADC_CR2, то по окончании преобразования АЦП генерирует запрос DMA. Контроллер DMA получит этот запрос по внутренней линии связи между периферией и DMA. Затем контроллер DMA считывает данные с АЦП (записанные в регистр ADC_DR) и записывает их в указанный адрес памяти.

В спецификации к микроконтроллеру имеется таблица запросов DMA.

.Таблица запросов DMA
image::DMA_Requests_Tables.png[]

Согласно этой таблице, для того, чтобы генерировать запросы от АЦП, следует использовать контроллер DMA2, канал 0, потоки 0 или 4. В данной работе используется поток 0.

В таблице ниже показана конфигурация регистров DMA для данного проекта.

|===
| Регистр | Поле (номера битов) | Значение | Назначение
| RCC_AHB1ENR | DMA2EN (22) | 1 | Подать тактирование на контроллер DMA2
+8.| DMA_S0CR | CHSEL (27 : 25) | 000 | Выбор канала 0
|
|===

